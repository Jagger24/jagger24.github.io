<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Pickleball Tournament - Dynamic Round Robin</title>
        <link rel="stylesheet" href="styles.css">
        <script src="tournament-data-4.js"></script> <!-- Verified -->
        <script src="tournament-data-5.js"></script> <!-- Verified -->
        <script src="tournament-data-6.js"></script> <!-- Needs Fixed -->
        <script src="tournament-data-7.js"></script> <!-- NEEDS FIXED -->
        <script src="tournament-data-8.js"></script> <!-- Verified -->
        <script src="tournament-data-9.js"></script> <!-- Verified-->
        <script src="tournament-data-10.js"></script> <!-- NEEDS FIXED -->
        <script src="tournament-data-11.js"></script> <!-- NEEDS FIXED -->
        <script src="tournament-data-12.js"></script> <!-- NEEDS FIXED -->
    </head>
    <body>
        <div class="container">
            <h1>üèì Pickleball Tournament - Dynamic Round Robin</h1>

            <!-- Control Buttons -->
            <div class="controls">
                <button class="btn btn-export" onclick="exportData()">üì§ Export Tournament Data</button>
                <button class="btn btn-import" onclick="document.getElementById('fileInput').click()">üì• Import Tournament Data</button>
                <button class="btn btn-clear" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                <input type="file" id="fileInput" class="file-input" accept=".json" onchange="importData(event)" />
            </div>

            <!-- Player Count Section -->
            <div class="player-count-section">
                <h3>Tournament Setup</h3>
                <div class="player-count-input">
                    <label>Select Tournament Format:</label>
                    <div class="tournament-options">
                        <button class="btn btn-tournament" onclick="loadTournament(4)">4 Players Tournament</button>
                        <button class="btn btn-tournament" onclick="loadTournament(5)">5 Players Tournament</button>
                        <!-- <button class="btn btn-tournament" onclick="loadTournament(6)">6 Players Tournament</button> -->
                        <!-- <button class="btn btn-tournament" onclick="loadTournament(7)">7 Players Tournament</button> -->
                        <button class="btn btn-tournament" onclick="loadTournament(8)">8 Players Tournament</button>
                        <button class="btn btn-tournament" onclick="loadTournament(9)">9 Players Tournament</button>
                        <!-- <button class="btn btn-tournament" onclick="loadTournament(10)">10 Players Tournament</button> -->
                        <!-- <button class="btn btn-tournament" onclick="loadTournament(11)">11 Players Tournament</button> -->
                        <!-- <button class="btn btn-tournament" onclick="loadTournament(12)">12 Players Tournament</button> -->
                        <!-- <button class="btn btn-tournament" onclick="loadTournament(13)">13 Players Tournament</button> -->
                        <!-- <button class="btn btn-tournament" onclick="loadTournament(14)">14 Players Tournament</button> -->
                        <!-- <button class="btn btn-tournament" onclick="loadTournament(15)">15 Players Tournament</button> -->
                        <!-- <button class="btn btn-tournament" onclick="loadTournament(16)">16 Players Tournament</button> -->
                    </div>
                </div>
                <div class="info-text">
                    Tournament will have <span id="roundsCount">3</span> rounds with <span id="matchesPerRound">1</span> matches per round
                    <br><span id="byeInfo">No bye weeks</span>
                </div>
            </div>

            <!-- Player Names Section -->
            <div class="player-section">
                <h3>Player Names</h3>
                <div class="player-grid" id="playerGrid">
                    <!-- Player inputs will be generated dynamically -->
                </div>
            </div>

            <!-- Tournament Rounds -->
            <div id="tournamentRounds">
                <!-- Rounds will be generated dynamically -->
            </div>

            <!-- Summary Section -->
            <div class="summary-section">
                <h3>üèÜ Tournament Standings</h3>
                <div class="summary-grid" id="summaryGrid">
                    <!-- Summary items will be generated dynamically -->
                </div>
            </div>
        </div>

        <!-- Toast notification -->
        <div id="toast" class="toast"></div>

        <script>
            let currentPlayerCount = 4;
            let matchConfigs = [];
            let playerStats = {};
            let tournamentData = null;


            // Load tournament from external data files
            function loadTournament(playerCount) {
                try {
                    // Get tournament data from external JS files
                    tournamentData = window[`tournamentData${playerCount}`];
                    if (!tournamentData) {
                        throw new Error(`Tournament data not found for ${playerCount} players`);
                    }
                    
                    if (!tournamentData) {
                        throw new Error(`Tournament data not loaded for ${playerCount} players`);
                    }
                    
                    currentPlayerCount = playerCount;
                    matchConfigs = tournamentData.tournamentStructure;
                    
                    // Update info text
                    const roundsCount = matchConfigs.length;
                    const matchesPerRound = Math.floor(playerCount / 4);
                    const playersOnBye = playerCount % 4;
                    document.getElementById('roundsCount').textContent = roundsCount;
                    document.getElementById('matchesPerRound').textContent = matchesPerRound;
                    
                    // Update bye info
                    const byeInfoElement = document.getElementById('byeInfo');
                    if (playersOnBye > 0) {
                        byeInfoElement.textContent = `${playersOnBye} player(s) on bye each round`;
                    } else {
                        byeInfoElement.textContent = 'No bye weeks';
                    }
                    
                    generatePlayerInputs();
                    generateTournamentRounds();
                    generateSummarySection();
                    
                    // Clear existing data
                    clearScores();
                    updatePlayerDisplays();
                    updateStats();
                    
                    showToast(`${playerCount} player tournament loaded successfully!`);
                } catch (error) {
                    console.error('Error loading tournament:', error);
                    showToast('Error loading tournament data. Please try again.', true);
                }
            }


            // Generate player input fields
            function generatePlayerInputs() {
                const playerGrid = document.getElementById('playerGrid');
                playerGrid.innerHTML = '';

                for (let i = 1; i <= currentPlayerCount; i++) {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'player-input';
                    playerDiv.innerHTML = `
                        <label>Player ${i}</label>
                        <input type="text" id="player${i}" placeholder="Enter name" />
                    `;
                    playerGrid.appendChild(playerDiv);
                }

                // Add event listeners
                for (let i = 1; i <= currentPlayerCount; i++) {
                    const input = document.getElementById(`player${i}`);
                    if (input) {
                        input.addEventListener('input', updatePlayerDisplays);
                    }
                }
            }

            // Generate tournament rounds
            function generateTournamentRounds() {
                const tournamentRounds = document.getElementById('tournamentRounds');
                tournamentRounds.innerHTML = '';

                matchConfigs.forEach((round, roundIndex) => {
                    const roundDiv = document.createElement('div');
                    roundDiv.className = 'round';
                    roundDiv.innerHTML = `<h3>Round ${roundIndex + 1}</h3>`;

                    const matchesDiv = document.createElement('div');
                    matchesDiv.className = 'matches';

                    round.forEach((match, matchIndex) => {
                        const matchDiv = document.createElement('div');
                        matchDiv.className = 'match';
                        
                        // Check if this is a bye week (from JSON structure)
                        if (match.type === 'bye') {
                            matchDiv.innerHTML = `
                                <h4>Bye Week</h4>
                                <div class="bye-players">
                                    <span class="bye-display" data-players="${match.players.join(',')}"></span>
                                </div>
                            `;
                            matchDiv.classList.add('bye-match');
                        } else {
                            matchDiv.innerHTML = `
                                <h4>Court ${String.fromCharCode(65 + matchIndex)}</h4>
                                <div class="team">
                                    <span class="team-names">
                                        <span class="player-display" data-players="${match[0][0]},${match[0][1]}"></span>
                                    </span>
                                    <input type="number" class="score-input" placeholder="Score" />
                                </div>
                                <div class="vs">VS</div>
                                <div class="team">
                                    <span class="team-names">
                                        <span class="player-display" data-players="${match[1][0]},${match[1][1]}"></span>
                                    </span>
                                    <input type="number" class="score-input" placeholder="Score" />
                                </div>
                            `;
                        }
                        matchesDiv.appendChild(matchDiv);
                    });
                    
                    // Add bye week display if tournament has bye data
                    if (tournamentData && tournamentData.byes && tournamentData.byes[roundIndex] !== undefined) {
                        const byePlayer = tournamentData.byes[roundIndex];
                        const byeDiv = document.createElement('div');
                        byeDiv.className = 'match bye-match';
                        byeDiv.innerHTML = `
                            <h4>Bye Week</h4>
                            <div class="bye-players">
                                <span class="bye-display" data-players="${byePlayer}"></span>
                            </div>
                        `;
                        matchesDiv.appendChild(byeDiv);
                    }

                    roundDiv.appendChild(matchesDiv);
                    tournamentRounds.appendChild(roundDiv);
                });

                // Add event listeners to score inputs
                document.querySelectorAll('.score-input').forEach((input) => {
                    input.addEventListener('input', updateStats);
                });
            }

            // Generate summary section
            function generateSummarySection() {
                const summaryGrid = document.getElementById('summaryGrid');
                summaryGrid.innerHTML = '';

                for (let i = 1; i <= currentPlayerCount; i++) {
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'summary-item';
                    summaryDiv.id = `summary-${i}`;
                    summaryDiv.innerHTML = `
                        <div class="rank-badge" id="rank-badge-${i}">${i}</div>
                        <div class="player-name">Player ${i}</div>
                        <div class="wins">0 Wins</div>
                        <div class="points">0 Points</div>
                        <div class="rank" id="rank-${i}">${i}th Place</div>
                    `;
                    summaryGrid.appendChild(summaryDiv);
                }
            }

            // Clear all scores
            function clearScores() {
                document.querySelectorAll('.score-input').forEach((input) => {
                    input.value = '';
                });
            }

            // Toast notification function
            function showToast(message, isError = false) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${isError ? 'error' : ''}`;
                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // Export tournament data
            function exportData() {
                const exportData = {
                    version: '3.0',
                    timestamp: new Date().toISOString(),
                    playerCount: currentPlayerCount,
                    players: {},
                    tournamentStructure: matchConfigs,
                    scores: [],
                };
                
                // Include bye data if it exists
                if (tournamentData && tournamentData.byes) {
                    exportData.byes = tournamentData.byes;
                }

                // Export player names
                for (let i = 1; i <= currentPlayerCount; i++) {
                    const input = document.getElementById(`player${i}`);
                    exportData.players[i] = input ? input.value || `Player ${i}` : `Player ${i}`;
                }

                // Export scores with match structure
                const scoreInputs = document.querySelectorAll('.score-input');
                let scoreIndex = 0;
                matchConfigs.forEach((round, roundIndex) => {
                    round.forEach((match, matchIndex) => {
                        if (match.type === 'bye') {
                            exportData.scores.push({
                                round: roundIndex + 1,
                                match: matchIndex + 1,
                                type: 'bye',
                                players: match.players
                            });
                        } else {
                            const team1Score = scoreInputs[scoreIndex] ? scoreInputs[scoreIndex].value || '' : '';
                            const team2Score = scoreInputs[scoreIndex + 1] ? scoreInputs[scoreIndex + 1].value || '' : '';
                            
                            const scoreEntry = {
                                round: roundIndex + 1,
                                match: matchIndex + 1,
                                team1: match[0],
                                team2: match[1],
                                team1Score: team1Score,
                                team2Score: team2Score
                            };
                            
                            // Add bye information if it exists
                            if (tournamentData && tournamentData.byes && tournamentData.byes[roundIndex] !== undefined) {
                                scoreEntry.bye = tournamentData.byes[roundIndex];
                            }
                            
                            exportData.scores.push(scoreEntry);
                            scoreIndex += 2;
                        }
                    });
                });

                // Create and download file
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `pickleball-doubles-tournament-${currentPlayerCount}players-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showToast('Tournament data exported successfully!');
            }

            // Import tournament data
            function importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const tournamentData = JSON.parse(e.target.result);

                        // Validate data structure
                        if (!tournamentData.players) {
                            throw new Error('Invalid tournament data format');
                        }

                        // Set player count and load tournament
                        if (tournamentData.playerCount) {
                            // Load the tournament structure
                            if (tournamentData.tournamentStructure) {
                                currentPlayerCount = tournamentData.playerCount;
                                matchConfigs = tournamentData.tournamentStructure;
                                
                                // Update info text
                                const roundsCount = matchConfigs.length;
                                const matchesPerRound = Math.floor(tournamentData.playerCount / 4);
                                const playersOnBye = tournamentData.playerCount % 4;
                                document.getElementById('roundsCount').textContent = roundsCount;
                                document.getElementById('matchesPerRound').textContent = matchesPerRound;
                                
                                // Update bye info
                                const byeInfoElement = document.getElementById('byeInfo');
                                if (playersOnBye > 0) {
                                    byeInfoElement.textContent = `${playersOnBye} player(s) on bye each round`;
                                } else {
                                    byeInfoElement.textContent = 'No bye weeks';
                                }

                                generatePlayerInputs();
                                generateTournamentRounds();
                                generateSummarySection();
                            } else {
                                showToast('Invalid tournament data format', true);
                                return;
                            }
                        }

                        // Import player names
                        for (let i = 1; i <= currentPlayerCount; i++) {
                            const input = document.getElementById(`player${i}`);
                            if (input && tournamentData.players[i]) {
                                input.value = tournamentData.players[i];
                            }
                        }

                        // Import scores
                        if (tournamentData.scores && tournamentData.scores.length > 0) {
                            // New format with structured scores
                            if (typeof tournamentData.scores[0] === 'object') {
                                const scoreInputs = document.querySelectorAll('.score-input');
                                let scoreIndex = 0;
                                
                                tournamentData.scores.forEach((scoreData) => {
                                    if (scoreData.type === 'bye') {
                                        // Skip bye weeks - no scores to import
                                        return;
                                    }
                                    
                                    if (scoreIndex < scoreInputs.length) {
                                        scoreInputs[scoreIndex].value = scoreData.team1Score || '';
                                        scoreInputs[scoreIndex + 1].value = scoreData.team2Score || '';
                                        scoreIndex += 2;
                                    }
                                });
                            } else {
                                // Old format with simple array
                                const scoreInputs = document.querySelectorAll('.score-input');
                                tournamentData.scores.forEach((score, index) => {
                                    if (index < scoreInputs.length && score !== '') {
                                        scoreInputs[index].value = score;
                                    }
                                });
                            }
                        }
                        
                        // Import bye data if it exists
                        if (tournamentData.byes) {
                            // Bye data is already loaded from the tournament structure
                        }

                        // Update displays
                        updatePlayerDisplays();
                        updateStats();

                        showToast('Tournament data imported successfully!');
                    } catch (error) {
                        console.error('Import error:', error);
                        showToast('Error importing tournament data. Please check the file format.', true);
                    }
                };

                reader.readAsText(file);
                event.target.value = '';
            }

            // Clear all data
            function clearAllData() {
                if (confirm('Are you sure you want to clear all tournament data? This action cannot be undone.')) {
                    // Clear player names
                    for (let i = 1; i <= currentPlayerCount; i++) {
                        const input = document.getElementById(`player${i}`);
                        if (input) input.value = '';
                    }

                    // Clear scores
                    clearScores();

                    // Update displays
                    updatePlayerDisplays();
                    updateStats();

                    showToast('All tournament data cleared!');
                }
            }

            // Update player display when names are entered
            function updatePlayerDisplays() {
                const players = {};
                for (let i = 1; i <= currentPlayerCount; i++) {
                    const input = document.getElementById(`player${i}`);
                    players[i] = input ? input.value || `Player ${i}` : `Player ${i}`;
                }

                // Update all player displays in matches
                document.querySelectorAll('.player-display').forEach((display) => {
                    const playerNumbers = display.getAttribute('data-players').split(',');
                    const playerNames = playerNumbers.map((num) => players[parseInt(num)]);
                    display.textContent = playerNames.join(' & ');
                });

                // Update bye week displays
                document.querySelectorAll('.bye-display').forEach((display) => {
                    const playerNumbers = display.getAttribute('data-players').split(',');
                    const playerNames = playerNumbers.map((num) => players[parseInt(num)]);
                    display.textContent = `Players on bye: ${playerNames.join(', ')}`;
                });

                // Update summary section player names
                for (let i = 1; i <= currentPlayerCount; i++) {
                    const summaryElement = document.getElementById(`summary-${i}`);
                    if (summaryElement) {
                        const playerNameElement = summaryElement.querySelector('.player-name');
                        if (playerNameElement) {
                            playerNameElement.textContent = players[i];
                        }
                    }
                }

                // Update stats
                updateStats();
            }

            function updateStats() {
                const scoreInputs = document.querySelectorAll('.score-input');
                playerStats = {};

                // Initialize stats for all players
                for (let i = 1; i <= currentPlayerCount; i++) {
                    playerStats[i] = { wins: 0, points: 0, playerId: i };
                }

                // Process each match
                let scoreIndex = 0;
                matchConfigs.forEach((round, roundIndex) => {
                    round.forEach((match) => {
                        // Skip bye weeks - no points or wins for players on bye
                        if (match.type === 'bye') {
                            return;
                        }

                        const team1Score = parseInt(scoreInputs[scoreIndex].value) || 0;
                        const team2Score = parseInt(scoreInputs[scoreIndex + 1].value) || 0;
                        scoreIndex += 2;

                        // Add points to each player on both teams
                        match[0].forEach((player) => {
                            playerStats[player].points += team1Score;
                        });
                        match[1].forEach((player) => {
                            playerStats[player].points += team2Score;
                        });

                        // Determine winner and add wins to all players on winning team
                        if (team1Score > team2Score) {
                            match[0].forEach((player) => {
                                playerStats[player].wins += 1;
                            });
                        } else if (team2Score > team1Score) {
                            match[1].forEach((player) => {
                                playerStats[player].wins += 1;
                            });
                        }
                    });
                    
                    // Handle bye weeks from JSON structure
                    if (tournamentData && tournamentData.byes && tournamentData.byes[roundIndex] !== undefined) {
                        // Player on bye gets no points or wins (already handled by not being in matches)
                    }
                });

                // Sort players by wins (descending), then by points (descending) as tie-breaker
                const sortedPlayers = Object.values(playerStats).sort((a, b) => {
                    if (b.wins !== a.wins) {
                        return b.wins - a.wins;
                    }
                    return b.points - a.points;
                });

                // Update the display with rankings
                for (let i = 0; i < sortedPlayers.length; i++) {
                    const player = sortedPlayers[i];
                    const summaryElement = document.getElementById(`summary-${player.playerId}`);
                    const rankBadge = document.getElementById(`rank-badge-${player.playerId}`);
                    const rankText = document.getElementById(`rank-${player.playerId}`);

                    if (summaryElement) {
                        const winsElement = summaryElement.querySelector('.wins');
                        const pointsElement = summaryElement.querySelector('.points');

                        if (winsElement) {
                            winsElement.textContent = `${player.wins} Wins`;
                        }
                        if (pointsElement) {
                            pointsElement.textContent = `${player.points} Points`;
                        }

                        // Update rank badge
                        if (rankBadge) {
                            rankBadge.textContent = i + 1;

                            // Style rank badges
                            rankBadge.className = 'rank-badge';
                            if (i === 0) {
                                rankBadge.classList.add('first');
                                summaryElement.classList.add('winner');
                                summaryElement.classList.remove('second', 'third');
                            } else if (i === 1) {
                                rankBadge.classList.add('second');
                                summaryElement.classList.add('second');
                                summaryElement.classList.remove('winner', 'third');
                            } else if (i === 2) {
                                rankBadge.classList.add('third');
                                summaryElement.classList.add('third');
                                summaryElement.classList.remove('winner', 'second');
                            } else {
                                summaryElement.classList.remove('winner', 'second', 'third');
                            }
                        }

                        // Update rank text
                        if (rankText) {
                            const place = i + 1;
                            let placeText;
                            if (place === 1) placeText = '1st Place';
                            else if (place === 2) placeText = '2nd Place';
                            else if (place === 3) placeText = '3rd Place';
                            else placeText = `${place}th Place`;

                            rankText.textContent = placeText;
                        }
                    }
                }
            }

            // Initialize tournament on page load
            window.onload = function () {
                loadTournament(4); // Load 4-player tournament by default
            };
        </script>
    </body>
</html>
